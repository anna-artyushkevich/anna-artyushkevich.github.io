(this.webpackJsonpchat_webapp=this.webpackJsonpchat_webapp||[]).push([[0],{168:function(e,t,n){e.exports=n(335)},173:function(e,t,n){},174:function(e,t,n){},272:function(e,t){},309:function(e,t){},335:function(e,t,n){"use strict";n.r(t);var a=n(1),s=n.n(a),i=n(51),r=n.n(i),l=(n(173),n(174),n(42)),o=n(2),c=n(10),h=n(11),u=n(12),d=n(13),p=n(0),m=n(14),g=n(165),b=n.n(g),v=n(52),y=n.n(v),f=n(106),C=n.n(f),w=n(167);function T(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function j(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?T(n,!0).forEach((function(t){Object(o.a)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):T(n).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var E="agents@gocurb.com",S=[{label:"John Webber",value:1},{label:"Tom Peet",value:2},{label:"Peter Kook",value:3},{label:"Artur Doil",value:4},{label:"+13155896818",value:5}];function O(e){return e.replace(/(((https?:\/\/)|(www\.))[^\s]+)/g,(function(e){return'<a href="'+e+'">'+e+"</a>"}))}var k=function(e){return s.a.createElement("div",{className:"chatApp__convTitle"},e.owner,"'s display")},N=function(e){function t(e,n){var a;return Object(c.a)(this,t),(a=Object(u.a)(this,Object(d.a)(t).call(this,e,n))).handleSendMessage=a.handleSendMessage.bind(Object(p.a)(a)),a.handleTyping=a.handleTyping.bind(Object(p.a)(a)),a}return Object(m.a)(t,e),Object(h.a)(t,[{key:"handleSendMessage",value:function(e){e.preventDefault(),this.messageInput.value.length>0&&(this.props.sendMessageLoading(this.ownerInput.value,this.messageInput.value),this.messageInput.value="")}},{key:"handleTyping",value:function(e){this.messageInput.value.length>0?this.props.typing(this.ownerInput.value):this.props.resetTyping(this.ownerInput.value)}},{key:"render",value:function(){var e=this,t=this.props.isLoading?"chatApp__convButton--loading":"",n=s.a.createElement("i",{className:"material-icons"},"send");return s.a.createElement("form",{onSubmit:this.handleSendMessage},s.a.createElement("input",{type:"hidden",ref:function(t){return e.ownerInput=t},value:this.props.owner}),s.a.createElement("input",{type:"text",ref:function(t){return e.messageInput=t},className:"chatApp__convInput",placeholder:"Send message...",onKeyDown:this.handleTyping,onKeyUp:this.handleTyping,tabIndex:"0"}),s.a.createElement("div",{className:"chatApp__convButton "+t,onClick:this.handleSendMessage},n))}}]),t}(s.a.Component),M=function(e){var t="",n=0;for(var a in e.isTyping)a!==e.owner&&e.isTyping[a]&&(t+=", "+a,n++);return t=t.substr(1),t+=n>1?" are ":" is ",n>0?s.a.createElement("div",{className:"chatApp__convTyping"},t," writing",s.a.createElement("span",{className:"chatApp__convTypingDot"})):s.a.createElement("div",{className:"chatApp__convTyping"})},A=function(e){function t(e,n){var a;return Object(c.a)(this,t),(a=Object(u.a)(this,Object(d.a)(t).call(this,e,n))).style={control:function(e,t){return j({},e,{border:(t.isFocused,0),boxShadow:(t.isFocused,0),"&:hover":{border:(t.isFocused,0)},fontSize:14})},option:function(e){return j({},e,{fontSize:14})}},a.handleChange=a.handleChange.bind(Object(p.a)(a)),a.drivers=[{label:"chat with fake drivers",options:[S[0],S[1],S[2],S[3]]},{label:"chat via textNow",options:[S[4]]}],a}return Object(m.a)(t,e),Object(h.a)(t,[{key:"handleChange",value:function(e){console.log("e:",e),5!==e.value?this.props.startViaWeb("web-".concat(e.value),"web"):this.props.startViaTextnow()}},{key:"render",value:function(){var e=this.props,t=e.isRoot,n=e.isSingleUser,a=e.currentChannel,i=e.endChat,r=e.allStatuses;console.log("currentChannel:",a);var l=a&&("web"===a.type?a.uniqueName.split("-").pop():"5"),o=S&&S.find((function(e){return e.value===parseInt(l)})),c=o&&o.label,h=r&&r.find((function(e){return e.channel===a.sid}));return console.log("value:",l,o,c,a,h,n),s.a.createElement("div",{className:"header"},t?s.a.createElement("div",{className:"all-conv"},"All Chats",s.a.createElement("button",{className:"link delete",onClick:this.props.deleteAllChannels},"Delete all textNow chats")):this.props.owner===E&&s.a.createElement(s.a.Fragment,null,s.a.createElement("button",{className:"link",onClick:this.props.backToRoot},s.a.createElement("i",{className:"fas fa-chevron-left"})),c?s.a.createElement("div",{className:"dropdown"},s.a.createElement("div",{className:"label"},c)):s.a.createElement("div",{className:"dropdown"},s.a.createElement("div",{className:"label"},"To:"),s.a.createElement(w.a,{placeholder:"Select Driver...",options:this.drivers,onChange:this.handleChange.bind(this),styles:this.style,isSearchable:!0})),!n&&!h&&s.a.createElement("div",{className:"end-chat"},s.a.createElement("i",{className:"fas fa-ellipsis-v"}),s.a.createElement("button",{className:"end-chat-btn",onClick:i.bind(this,a.sid)},s.a.createElement("i",{className:"fas fa-times"})," End this chat session"))))}}]),t}(s.a.Component),_=function(e){function t(e,n){var a;return Object(c.a)(this,t),(a=Object(u.a)(this,Object(d.a)(t).call(this,e,n))).state={isLoading:!1},a.sendMessageLoading=a.sendMessageLoading.bind(Object(p.a)(a)),a}return Object(m.a)(t,e),Object(h.a)(t,[{key:"sendMessageLoading",value:function(e,t){var n=this;this.setState({isLoading:!0}),this.props.sendMessage(e,t),setTimeout((function(){n.setState({isLoading:!1})}),400)}},{key:"render",value:function(){var e=this,t=this.props.allStatuses&&this.props.allStatuses.find((function(t){return t.channel===e.props.currentChannel.sid}));return s.a.createElement("div",{className:"chatApp__convSendMessage clearfix"},this.props.isRoot?s.a.createElement("div",{className:"start-chat-wrapper"},s.a.createElement("button",{className:"btn start-chat",onClick:this.props.startEmptyChat},"Start New Chat")):!this.props.isSingleUser&&!t&&s.a.createElement(s.a.Fragment,null,s.a.createElement(M,{owner:this.props.owner,isTyping:this.props.isTyping}),s.a.createElement(N,{isLoading:this.state.isLoading,owner:this.props.owner,sendMessage:this.props.sendMessage,sendMessageLoading:this.sendMessageLoading,typing:this.props.typing,resetTyping:this.props.resetTyping})))}}]),t}(s.a.Component),I=function(e){function t(e,n){return Object(c.a)(this,t),Object(u.a)(this,Object(d.a)(t).call(this,e,n))}return Object(m.a)(t,e),Object(h.a)(t,[{key:"render",value:function(){var e=this,t=this.props,n=t.messages;return!t.isRoot&&s.a.createElement("div",{className:"chatApp__convTimeline"},n.slice(0).reverse().map((function(t){return s.a.createElement(L,{key:t.id,owner:e.props.owner,sender:t.sender,message:t.message,timestamp:t.timestamp})})))}}]),t}(s.a.Component),L=function(e){var t=e.owner===e.sender?"chatApp__convMessageItem--left":"chatApp__convMessageItem--right";return s.a.createElement("div",{className:"chatApp__convMessageItem "+t+" clearfix"},s.a.createElement("div",{className:"chatApp__convMessageValue",dangerouslySetInnerHTML:{__html:e.message}}),s.a.createElement("div",{className:"chatApp__convMessageTime"},C()(e.timestamp).fromNow()),s.a.createElement("div",{className:"chatApp__convMessageAvatar"},e.sender))},x=function(e){function t(e,n){var a;return Object(c.a)(this,t),(a=Object(u.a)(this,Object(d.a)(t).call(this,e,n))).clickHandler=a.clickHandler.bind(Object(p.a)(a)),a}return Object(m.a)(t,e),Object(h.a)(t,[{key:"clickHandler",value:function(e){console.log("onClick channel:",e.uniqueName," ",e.sid);var t=e.uniqueName?"web":"textnow";this.props.joinChannel(e.uniqueName||e.sid,t)}},{key:"render",value:function(){var e=this.props,t=e.isRoot,n=e.channelList,a=e.allStatuses;if(!t)return!1;var i=this.clickHandler,r=!1;return console.log("allStatuses: ",a),s.a.createElement("div",{className:"chatApp__convTimeline"},s.a.createElement("div",{className:"chatApp__convChannelLine"},Object.keys(n).map((function(e){var t,l=n[e],o=a&&a.find((function(e){return e.channel===l.sid}));return o&&(t=o.status,r=!r),s.a.createElement("a",Object.assign({key:e,className:"channelItem ".concat(t)},t&&r&&{"data-header":"Archived chats"},{onClick:i.bind(this,l)}),s.a.createElement("div",null,s.a.createElement("div",{className:"channelAuthor"},l.author),s.a.createElement("div",{className:"channelTime"},l.timestamp&&C()(l.timestamp).fromNow())),s.a.createElement("div",null,s.a.createElement("div",{className:"channelBody"},l.body),s.a.createElement("div",{className:"channelName"},l.friendlyName)))}))))}}]),t}(s.a.Component),R=function(e){return s.a.createElement("div",{className:"chatApp__conv"},s.a.createElement(k,{owner:e.owner}),s.a.createElement(A,{isRoot:e.isRoot,owner:e.owner,isSingleUser:e.isSingleUser,startViaWeb:e.startViaWeb,startViaTextnow:e.startViaTextnow,deleteAllChannels:e.deleteAllChannels,backToRoot:e.backToRoot,allStatuses:e.allStatuses,endChat:e.endChat,currentChannel:e.currentChannel}),s.a.createElement(I,{owner:e.owner,messages:e.messages,isRoot:e.isRoot}),s.a.createElement(x,{channelList:e.channelList,joinChannel:e.joinChannel,allStatuses:e.allStatuses,endChat:e.endChat,isRoot:e.isRoot}),s.a.createElement(_,{owner:e.owner,isTyping:e.isTyping,sendMessage:e.sendMessage,typing:e.typing,resetTyping:e.resetTyping,isRoot:e.isRoot,startEmptyChat:e.startEmptyChat,allStatuses:e.allStatuses,isSingleUser:e.isSingleUser,currentChannel:e.currentChannel}))},U=function(e){function t(e,n){var a;return Object(c.a)(this,t),(a=Object(u.a)(this,Object(d.a)(t).call(this,e,n))).state={isTyping:[],error:null,isLoading:!0,channel:null,root:!0,messages:[],messagesReal:[],allChannels:[],users:[],currentChannel:null,allChannelStatuses:[],currentTextnowChatId:null},a.typing=a.typing.bind(Object(p.a)(a)),a.resetTyping=a.resetTyping.bind(Object(p.a)(a)),a.getAllChannels=a.getAllChannels.bind(Object(p.a)(a)),a.setupChatClient=a.setupChatClient.bind(Object(p.a)(a)),a.messagesLoaded=a.messagesLoaded.bind(Object(p.a)(a)),a.messageAdded=a.messageAdded.bind(Object(p.a)(a)),a.sendMessage=a.sendMessage.bind(Object(p.a)(a)),a.handleError=a.handleError.bind(Object(p.a)(a)),a.setupSecondaryChat=a.setupSecondaryChat.bind(Object(p.a)(a)),a.setupChatBySMS=a.setupChatBySMS.bind(Object(p.a)(a)),a.deleteAllTextnowChannels=a.deleteAllTextnowChannels.bind(Object(p.a)(a)),a.deleteCurrentTextnowChannels=a.deleteCurrentTextnowChannels.bind(Object(p.a)(a)),a.twilioMessageToUIMessageReal=a.twilioMessageToUIMessageReal.bind(Object(p.a)(a)),a.twilioMessageToUIMessage=a.twilioMessageToUIMessage.bind(Object(p.a)(a)),a.backToChannelList=a.backToChannelList.bind(Object(p.a)(a)),a.startEmptyChat=a.startEmptyChat.bind(Object(p.a)(a)),a.endChat=a.endChat.bind(Object(p.a)(a)),a.identity=E,a.URL="https://ehail.stage.gocurb.com:5443",a.agent={name:E},a.driverWeb={name:"driver in web"},a.driverTextNow={name:"+13155896818"},a.driverId="1",a.communicationType="SMS",a.client=null,a.rootChannel="all-agents",a}return Object(m.a)(t,e),Object(h.a)(t,[{key:"componentWillMount",value:function(){var e=this,t=this.URL,n=this.identity;y.a.ajax({url:t+"/token",type:"POST",contentType:"application/json",data:'{"identity":"'+n+'"}'}).then((function(e){return b.a.create(e.token)})).then((function(t){return e.client=t,t})).then(this.getAllChannels).catch(this.handleError)}},{key:"componentWillUnmount",value:function(){this.deleteCurrentTextnowChannels()}},{key:"handleError",value:function(e){console.error(e),this.setState({error:"Could not load chat."})}},{key:"getAllChannels",value:function(e){var t=this,n=e||this.client,a=[];console.log("this.client: ",this.client),n.getUserChannelDescriptors().then((function(e){console.log("paginator: ",e);var t=y.a.when();return e.items.forEach((function(e){t=t.then((function(){return n.getChannelByUniqueName(e.uniqueName||e.sid).then((function(e){return e.getMessages().then((function(t){console.log("Channel: ",e),console.log("Channel messages: ",t.items);var n=t.items.length,s=t.items[n-1];a.push({uniqueName:e.uniqueName,sid:e.sid,friendlyName:e.friendlyName,author:s&&s.author||"",body:s&&s.body||"",timestamp:s&&s.timestamp||null})}))}))}))})),t})).then((function(){var e=[t.agent];a.sort((function(e,t){return new Date(e.timestamp).getTime()>new Date(t.timestamp).getTime()?1:-1})),t.setState({allChannels:a,users:e}),console.log("users: ",t.state.users)}))}},{key:"setupChatClient",value:function(e){var t=this;this.client=e,this.client.getChannelByUniqueName(this.rootChannel).then((function(e){return e})).catch((function(e){if(50300===e.body.code)return t.client.createChannel({uniqueName:t.rootChannel});t.handleError(e)})).then((function(e){return t.channel=e,console.log("this.channel: ",t.channel,",  this.client",t.client),t.setState({channel:e,root:!1}),t.channel.join().catch((function(){}))})).then((function(){t.setState({isLoading:!1}),t.channel.getMessages().then(t.messagesLoaded),t.channel.on("messageAdded",t.messageAdded)})).catch(this.handleError)}},{key:"setupSecondaryChat",value:function(e,t){var n=this;console.log("setupSecondaryChat channelName",e),this.client.getChannelByUniqueName(e).then((function(e){return e})).catch((function(a){if(a&&a.body&&50300===a.body.code)return n.client.createChannel({uniqueName:e,friendlyName:"web"===t?"web-1"===e?"John Webber via Web":"web-2"===e?"Tom Peet via Web":"web-3"===e?"Peter Kook via Web":"Artur Doil via Web":"Driver via TextNow"});n.handleError(a)})).then((function(e){return n.channel=e,console.log("setupSecondaryChat this.channel: ",n.channel),n.setState({channel:e,root:!1,currentChannel:{sid:e.sid,uniqueName:e.uniqueName,type:t}}),n.channel.join().catch((function(){}))})).then((function(){n.setState({isLoading:!1}),n.channel.getMessages().then(n.messagesLoaded),console.log("type: ",t),n.setState({users:[].concat(Object(l.a)(n.state.users),["web"===t?"web-1"===e?{name:"John Webber"}:"web-2"===e?{name:"Tom Peet"}:"web-3"===e?{name:"Peter Kook"}:{name:"Artur Doil"}:n.driverTextNow])}),console.log("users: ",n.state.users),console.log("currentChannel: ",n.state.currentChannel),n.channel.on("messageAdded",n.messageAdded)})).catch(this.handleError)}},{key:"deleteAllTextnowChannels",value:function(){for(var e=this,t=this.URL,n=this.identity,a=1;a<=20;a++)y.a.ajax({url:t+"/chats/"+a,type:"DELETE",headers:{Authorization:"Bearer "+n}}).then((function(t){console.log("response: ",t),e.client.leave()}))}},{key:"deleteCurrentTextnowChannels",value:function(){var e=this,t=this.URL,n=this.identity;this.state.currentTextnowChatId&&y.a.ajax({url:t+"/chats/"+this.state.currentTextnowChatId,type:"DELETE",headers:{Authorization:"Bearer "+n}}).then((function(t){console.log("response: ",t),e.client.leave()}))}},{key:"setupChatBySMS",value:function(){var e=this,t=this.URL,n=this.identity,a=this.driverId,s=this.communicationType;y.a.ajax({url:t+"/chats",type:"POST",headers:{Authorization:"Bearer "+n},contentType:"application/json",data:'{"communicationType": "'+s+'","masterDriverId": "'+a+'"}'}).then((function(e){return y.a.ajax({url:t+"/chats/"+e.chatId,type:"PUT",headers:{Authorization:"Bearer "+n},contentType:"application/json"})})).catch((function(e){return console.log("error: ",e)})).then((function(t){e.setState({currentTextnowChatId:t.chatId}),console.log("currentTextnowChatId: ",e.state.currentTextnowChatId),e.setupSecondaryChat(t.twilioChatId,"textnow")})).catch(this.handleError)}},{key:"sendMessage",value:function(e,t){var n=this;setTimeout((function(){var a={id:n.state.messagesReal.length,sender:e,message:O(t),timestamp:new Date};n.setState((function(e){return{messagesReal:[].concat(Object(l.a)(e.messagesReal),[a])}})),n.channel.sendMessage(t),n.resetTyping(e)}),400)}},{key:"typing",value:function(e){if(!this.state.isTyping[e]){var t=this.state.isTyping;t[e]=!0,this.setState({isTyping:t})}}},{key:"resetTyping",value:function(e){var t=this.state.isTyping;t[e]=!1,this.setState({isTyping:t})}},{key:"twilioMessageToUIMessage",value:function(e,t){return{id:t,message:e.body,sender:e.author,timestamp:e.timestamp}}},{key:"twilioMessageToUIMessageReal",value:function(e,t){var n=this.state.messagesReal,a=n&&n.find((function(t){return t.message===e.body})),s=a&&a.sender;return{id:t,message:e.body,sender:s||e.author,timestamp:e.timestamp}}},{key:"messagesLoaded",value:function(e){this.setState({messages:e.items.map(this.twilioMessageToUIMessage),messagesReal:e.items.map(this.twilioMessageToUIMessageReal)})}},{key:"messageAdded",value:function(e){var t=this;this.setState((function(n){return{messages:[].concat(Object(l.a)(n.messages),[t.twilioMessageToUIMessageReal(e,n.messages.length)])}}))}},{key:"startEmptyChat",value:function(){this.setState({root:!1,messagesReal:[],messages:[],currentChannel:null})}},{key:"endChat",value:function(e){console.log("sid: ",e),this.setState((function(t){return{allChannelStatuses:[].concat(Object(l.a)(t.allChannelStatuses),[{channel:e,status:"archived"}])}})),console.log("this.state.allChannelStatuses: ",this.state.allChannelStatuses),this.backToChannelList()}},{key:"backToChannelList",value:function(){this.getAllChannels(),this.setState({users:[this.agent],root:!0})}},{key:"render",value:function(){var e=this.state,t=e.users,n=e.root,a=e.messages,i=e.isTyping,r=e.allChannels,l=e.allChannelStatuses,o=e.currentChannel,c=this.sendMessage,h=this.setupSecondaryChat,u=this.setupChatBySMS,d=this.typing,p=this.resetTyping,m=this.endChat,g=this.backToChannelList,b=this.startEmptyChat,v=this.deleteAllTextnowChannels,y=[];return Object.keys(t).map((function(e){var f=t[e];return n&&e>0?null:y.push(s.a.createElement(R,{key:e,owner:f.name,sendMessage:c,typing:d,resetTyping:p,messages:a,isTyping:i,isRoot:n,isSingleUser:1===t.length,channelList:r,allStatuses:l,joinChannel:h,startEmptyChat:b,startViaWeb:h,startViaTextnow:u,deleteAllChannels:v,backToRoot:g,endChat:m,currentChannel:o}))})),s.a.createElement("div",{className:"chatApp__room"},y)}}]),t}(s.a.Component);setTimeout((function(){r.a.render(s.a.createElement(U,null),document.getElementById("root"))}),400)}},[[168,1,2]]]);
//# sourceMappingURL=main.980f9079.chunk.js.map